<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Tagalong</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* ─── LOGIN ─── */
    .login-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: var(--hero-gradient);
    }

    .login-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 40px 32px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: var(--card-shadow);
    }

    .login-card h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -.02em;
    }

    .login-card p {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    .login-card input {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      margin-bottom: 16px;
      outline: none;
      transition: border-color .2s;
    }

    .login-card input:focus {
      border-color: var(--accent);
    }

    .login-card input::placeholder {
      color: var(--text-tertiary);
    }

    .login-error {
      color: var(--error);
      font-size: 13px;
      margin-bottom: 12px;
      display: none;
    }

    /* ─── ADMIN BUTTONS ─── */
    .btn-small { padding: 6px 14px; font-size: 13px }
    .btn-danger { background: rgba(229,62,62,0.08); color: var(--error); border: 1px solid rgba(229,62,62,0.15) }
    .btn-danger:hover { background: rgba(229,62,62,0.14) }
    .btn-accent { background: var(--accent); color: #FFFFFF }
    .btn-accent:hover { background: var(--accent-hover); transform: translateY(-1px) }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-full { width: 100%; justify-content: center }
    .btn-tiny { padding: 4px 10px; font-size: 11px; border-radius: 6px }

    /* ─── DASHBOARD LAYOUT ─── */
    .dashboard { display: none; }

    .dashboard-header {
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: rgba(250,250,247,.92);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index: 100;
      gap: 12px;
    }

    .dashboard-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .dashboard-header-left img { height: 32px }

    .dashboard-header-left h1 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .dashboard-header-left h1 span {
      color: var(--accent);
      font-weight: 700;
    }

    .dashboard-header-center {
      flex: 1;
      max-width: 400px;
    }

    .search-input {
      width: 100%;
      padding: 8px 14px 8px 36px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: border-color .2s;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239B9B9B' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
    }

    .search-input:focus { border-color: var(--accent) }
    .search-input::placeholder { color: var(--text-tertiary) }

    .dashboard-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dashboard-body {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* ─── STATS CARDS ─── */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      position: relative;
    }

    .stat-card-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stat-card-label svg { width: 14px; height: 14px; stroke-width: 2 }

    .stat-card-value {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -.02em;
      color: var(--accent);
    }

    .stat-card-value.green { color: var(--success) }
    .stat-card-value.red { color: var(--error) }

    .stat-card-sub {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .stat-card-action {
      position: absolute;
      top: 16px;
      right: 16px;
    }

    /* ─── SECTIONS ─── */
    .admin-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 24px;
      overflow: hidden;
    }

    .admin-section-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .admin-section-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .admin-section-header-left svg { width: 18px; height: 18px; color: var(--accent); stroke-width: 2 }

    .admin-section-header-left h2 {
      font-size: 15px;
      font-weight: 700;
    }

    .admin-section-header-left .count {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      background: var(--surface-secondary);
      padding: 2px 8px;
      border-radius: 10px;
    }

    .admin-section-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-select {
      padding: 5px 10px;
      background: var(--surface-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 12px;
      font-family: inherit;
      outline: none;
      cursor: pointer;
    }

    .filter-select:focus { border-color: var(--accent) }

    /* ─── TABLES ─── */
    .table-wrapper {
      overflow-x: auto;
    }

    .admin-section table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .admin-section thead th {
      padding: 10px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: var(--text-secondary);
      background: var(--surface-secondary);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    .admin-section thead th.right { text-align: right }

    .admin-section tbody td {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .admin-section tbody td.right { text-align: right }

    .admin-section tbody tr:last-child td { border-bottom: none }

    .admin-section tbody tr:hover { background: var(--accent-subtle) }

    .mono {
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
      font-size: 12px;
    }

    .truncate {
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      vertical-align: middle;
    }

    .copyable {
      cursor: pointer;
      position: relative;
    }

    .copyable:hover { color: var(--accent) }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .03em;
    }

    .badge-active { background: var(--accent-subtle); color: var(--accent) }
    .badge-inactive { background: var(--surface-secondary); color: var(--text-tertiary) }
    .badge-pro { background: var(--accent-subtle); color: var(--accent) }
    .badge-free { background: var(--surface-secondary); color: var(--text-tertiary) }

    /* Customer cell */
    .customer-cell { display: flex; flex-direction: column; gap: 2px }
    .customer-email { color: var(--text); font-weight: 500 }
    .customer-device { font-size: 11px; color: var(--text-tertiary); font-family: 'SF Mono', 'Fira Code', monospace }

    /* ─── USAGE SECTION ─── */
    .usage-controls {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .usage-controls label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .usage-controls input[type="month"] {
      padding: 6px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
      outline: none;
    }

    .usage-controls input[type="month"]:focus {
      border-color: var(--accent);
    }

    .usage-summary {
      padding: 12px 20px;
      background: var(--surface-secondary);
      font-size: 13px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    .usage-summary strong {
      font-weight: 700;
    }

    .usage-summary .cost { color: var(--error) }
    .usage-summary .revenue { color: var(--success) }
    .usage-summary .profit { color: var(--secondary) }

    .profit-positive { color: var(--success) }
    .profit-negative { color: var(--error) }

    /* ─── LICENSE FORM ─── */
    .license-form {
      display: none;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--surface-secondary);
    }

    .license-form.visible { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-group label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: var(--text-secondary);
    }

    .form-group select,
    .form-group input[type="text"] {
      padding: 8px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      min-width: 140px;
    }

    .form-group select:focus,
    .form-group input[type="text"]:focus {
      border-color: var(--accent);
    }

    /* ─── LOADING / EMPTY ─── */
    .loading-row td {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-tertiary);
    }

    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .8s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin { to { transform: rotate(360deg) } }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-tertiary);
      font-size: 14px;
    }

    .error-state {
      text-align: center;
      padding: 20px;
      color: var(--error);
      font-size: 14px;
    }

    /* ─── EXPANDABLE DETAIL ROWS ─── */
    .admin-section tbody tr.expandable { cursor: pointer }
    .admin-section tbody tr.expandable:hover { background: rgba(45,125,70,0.04) }
    .admin-section tbody tr.expandable td:first-child::before {
      content: '\25B6';
      display: inline-block;
      font-size: 9px;
      margin-right: 6px;
      transition: transform .2s;
      color: var(--text-tertiary);
    }
    .admin-section tbody tr.expandable.expanded td:first-child::before {
      transform: rotate(90deg);
    }
    tr.detail-row { display: none }
    tr.detail-row.visible { display: table-row }
    tr.detail-row td {
      padding: 0 16px 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--surface-secondary);
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 8px;
      padding: 12px 0 4px 0;
    }
    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .detail-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--text-tertiary);
    }
    .detail-value {
      font-size: 12px;
      color: var(--text-secondary);
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
      word-break: break-all;
    }
    .detail-value.copyable { cursor: pointer }
    .detail-value.copyable:hover { color: var(--accent) }

    /* ─── TOAST ─── */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      box-shadow: var(--card-shadow);
      transform: translateY(80px);
      opacity: 0;
      transition: all .3s ease;
      z-index: 200;
    }

    .toast.visible {
      transform: translateY(0);
      opacity: 1;
    }

    /* ─── RESPONSIVE ─── */
    @media (max-width: 1100px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr) }
    }

    @media (max-width: 768px) {
      .dashboard-header { flex-wrap: wrap }
      .dashboard-header-center { max-width: none; order: 3; width: 100% }
      .stats-grid { grid-template-columns: repeat(2, 1fr) }
    }

    @media (max-width: 600px) {
      .stats-grid { grid-template-columns: 1fr }
      .dashboard-header { padding: 12px 16px }
      .dashboard-body { padding: 16px }
      .admin-section-header { flex-direction: column; gap: 10px; align-items: flex-start }
      .license-form.visible { flex-direction: column; align-items: stretch }
      .usage-controls { flex-wrap: wrap }
    }
  </style>
</head>
<body class="admin-layout">

  <!-- LOGIN -->
  <div id="loginView" class="login-wrapper">
    <div class="login-card">
      <div style="margin-bottom: 20px">
        <img src="assets/logo-light.png" alt="Tagalong" style="height: 40px">
      </div>
      <h1>Admin Dashboard</h1>
      <p>Enter the admin secret to continue.</p>
      <div id="loginError" class="login-error"></div>
      <input type="password" id="secretInput" placeholder="Admin secret" autocomplete="off" autofocus>
      <button class="btn btn-primary btn-full" id="loginBtn" onclick="handleLogin()">Sign In</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardView" class="dashboard">

    <!-- HEADER -->
    <div class="dashboard-header">
      <div class="dashboard-header-left">
        <img src="assets/logo-light.png" alt="Tagalong">
        <h1><span>Admin</span> Dashboard</h1>
      </div>
      <div class="dashboard-header-center">
        <input type="text" class="search-input" id="globalSearch" placeholder="Search by email, device ID, or Stripe ID..." oninput="handleGlobalSearch()">
      </div>
      <div class="dashboard-header-right">
        <button class="btn btn-outline btn-small" onclick="refreshAll()">
          <i data-lucide="refresh-cw" style="width:14px;height:14px"></i> Refresh
        </button>
        <button class="btn btn-danger btn-small" onclick="handleLogout()">
          <i data-lucide="log-out" style="width:14px;height:14px"></i> Logout
        </button>
      </div>
    </div>

    <div class="dashboard-body">

      <!-- STATS -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-card-label"><i data-lucide="monitor-smartphone"></i> Total Devices</div>
          <div class="stat-card-value" id="statDevices">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label"><i data-lucide="users"></i> Unique Subscribers</div>
          <div class="stat-card-value" id="statSubscribers">--</div>
          <div class="stat-card-sub" id="statDevicesSub"></div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label"><i data-lucide="key"></i> Active Licenses</div>
          <div class="stat-card-value" id="statLicenses">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label"><i data-lucide="dollar-sign"></i> MRR</div>
          <div class="stat-card-value green" id="statMRR">--</div>
          <div class="stat-card-action">
            <button class="btn btn-outline btn-tiny" onclick="verifyWithStripe()" id="stripeVerifyBtn">Verify with Stripe</button>
          </div>
          <div class="stat-card-sub" id="statMRRSub"></div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label"><i data-lucide="trending-down"></i> Est. API Cost</div>
          <div class="stat-card-value red" id="statApiCost">--</div>
          <div class="stat-card-sub" id="statApiCostSub">This month</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label"><i data-lucide="trending-up"></i> Net Margin</div>
          <div class="stat-card-value green" id="statNetMargin">--</div>
          <div class="stat-card-sub" id="statNetMarginSub"></div>
        </div>
      </div>

      <!-- LICENSES -->
      <div class="admin-section">
        <div class="admin-section-header">
          <div class="admin-section-header-left">
            <i data-lucide="key-round"></i>
            <h2>Licenses</h2>
            <span class="count" id="licensesCount">0</span>
          </div>
          <button class="btn btn-accent btn-small" id="generateBtn" onclick="toggleLicenseForm()">
            <i data-lucide="plus" style="width:14px;height:14px"></i> Generate License
          </button>
        </div>
        <div class="license-form" id="licenseForm">
          <div class="form-group">
            <label>Tier</label>
            <select id="licenseTier">
              <option value="pro">Pro</option>
              <option value="free">Free</option>
            </select>
          </div>
          <div class="form-group" style="flex:1;min-width:200px">
            <label>Note (optional)</label>
            <input type="text" id="licenseNote" placeholder="e.g. Early adopter gift">
          </div>
          <button class="btn btn-accent btn-small" onclick="generateLicense()" id="createLicenseBtn">Create</button>
          <button class="btn btn-outline btn-small" onclick="toggleLicenseForm()">Cancel</button>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>License Key</th>
                <th>Tier</th>
                <th>Created</th>
                <th>Max Devices</th>
                <th>Note</th>
                <th>Activated Device</th>
              </tr>
            </thead>
            <tbody id="licensesBody">
              <tr class="loading-row"><td colspan="6"><span class="spinner"></span> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- USAGE -->
      <div class="admin-section">
        <div class="admin-section-header">
          <div class="admin-section-header-left">
            <i data-lucide="bar-chart-3"></i>
            <h2>Usage</h2>
          </div>
        </div>
        <div class="usage-controls">
          <label for="usageMonth">Month:</label>
          <input type="month" id="usageMonth" onchange="fetchUsageDetailed()">
        </div>
        <div class="usage-summary" id="usageSummary" style="display:none"></div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Customer</th>
                <th class="right">OpenAI</th>
                <th class="right">AssemblyAI</th>
                <th class="right">Gemini</th>
                <th class="right">Total</th>
                <th class="right">Cost</th>
                <th class="right">Revenue</th>
                <th class="right">Profit</th>
              </tr>
            </thead>
            <tbody id="usageBody">
              <tr class="loading-row"><td colspan="8"><span class="spinner"></span> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- DEVICES -->
      <div class="admin-section">
        <div class="admin-section-header">
          <div class="admin-section-header-left">
            <i data-lucide="monitor-smartphone"></i>
            <h2>Devices</h2>
            <span class="count" id="subscribersCount">0</span>
          </div>
          <div class="admin-section-header-right">
            <select class="filter-select" id="subscriberStatusFilter" onchange="renderSubscribers()">
              <option value="all">All Statuses</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
            <select class="filter-select" id="subscriberTierFilter" onchange="renderSubscribers()">
              <option value="all">All Tiers</option>
              <option value="pro">Pro</option>
              <option value="free">Free</option>
            </select>
          </div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Customer</th>
                <th>Status</th>
                <th>Tier</th>
                <th>Stripe Customer</th>
                <th>Registered</th>
                <th>Last Seen</th>
              </tr>
            </thead>
            <tbody id="subscribersBody">
              <tr class="loading-row"><td colspan="6"><span class="spinner"></span> Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <script>
    var API_BASE = 'https://api.tagalongai.com';

    // --- Data stores for client-side filtering ---
    var subscribersData = [];
    var licensesData = [];
    var usageData = [];
    var usageTotals = {};
    var globalSearchQuery = '';

    // --- Auth ---

    function getSecret() {
      return sessionStorage.getItem('tagalong_admin_secret') || '';
    }

    function handleLogin() {
      var secret = document.getElementById('secretInput').value.trim();
      if (!secret) {
        showLoginError('Please enter the admin secret.');
        return;
      }
      var btn = document.getElementById('loginBtn');
      btn.disabled = true;
      btn.textContent = 'Signing in...';

      apiFetch('/v1/admin/stats', { secret: secret })
        .then(function () {
          sessionStorage.setItem('tagalong_admin_secret', secret);
          showDashboard();
        })
        .catch(function (err) {
          showLoginError(err.status === 403 || err.status === 401 ? 'Invalid admin secret.' : 'Connection failed. Check the API.');
        })
        .finally(function () {
          btn.disabled = false;
          btn.textContent = 'Sign In';
        });
    }

    function handleLogout() {
      sessionStorage.removeItem('tagalong_admin_secret');
      document.getElementById('dashboardView').style.display = 'none';
      document.getElementById('loginView').style.display = 'flex';
      document.getElementById('secretInput').value = '';
      document.getElementById('loginError').style.display = 'none';
    }

    function showLoginError(msg) {
      var el = document.getElementById('loginError');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function showDashboard() {
      document.getElementById('loginView').style.display = 'none';
      document.getElementById('dashboardView').style.display = 'block';
      lucide.createIcons();

      // Set usage month to current
      var now = new Date();
      var month = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
      document.getElementById('usageMonth').value = month;

      refreshAll();
    }

    // --- API ---

    function apiFetch(path, opts) {
      opts = opts || {};
      var secret = opts.secret || getSecret();
      var fetchOpts = {
        method: opts.method || 'GET',
        headers: {
          'Authorization': 'Bearer ' + secret,
          'Content-Type': 'application/json'
        }
      };
      if (opts.body) {
        fetchOpts.body = JSON.stringify(opts.body);
      }
      return fetch(API_BASE + path, fetchOpts).then(function (res) {
        if (!res.ok) {
          var err = new Error('HTTP ' + res.status);
          err.status = res.status;
          throw err;
        }
        return res.json();
      });
    }

    // --- Global Search ---

    function handleGlobalSearch() {
      globalSearchQuery = document.getElementById('globalSearch').value.trim().toLowerCase();
      renderSubscribers();
      renderLicenses();
      renderUsage();
    }

    function matchesSearch(item) {
      if (!globalSearchQuery) return true;
      var q = globalSearchQuery;
      var fields = [
        item.email, item.deviceId, item.stripeCustomerId,
        item.licenseKey, item.note, item.activatedDeviceId
      ];
      for (var i = 0; i < fields.length; i++) {
        if (fields[i] && fields[i].toLowerCase().indexOf(q) !== -1) return true;
      }
      return false;
    }

    // --- Refresh ---

    function refreshAll() {
      fetchStats();
      fetchSubscribers();
      fetchLicenses();
      fetchUsageDetailed();
    }

    // --- Stats ---

    function fetchStats() {
      var ids = ['statDevices', 'statSubscribers', 'statLicenses', 'statMRR'];
      ids.forEach(function (id) { document.getElementById(id).textContent = '...'; });
      document.getElementById('statApiCost').textContent = '...';
      document.getElementById('statNetMargin').textContent = '...';

      apiFetch('/v1/admin/stats')
        .then(function (data) {
          document.getElementById('statDevices').textContent = data.totalDevices;
          document.getElementById('statSubscribers').textContent = data.uniqueSubscribers;
          document.getElementById('statDevicesSub').textContent = data.activeDevices + ' active device' + (data.activeDevices !== 1 ? 's' : '');
          document.getElementById('statLicenses').textContent = data.activeLicenses;
          document.getElementById('statMRR').textContent = '$' + data.mrr;
          document.getElementById('statMRRSub').textContent = data.mrrSource === 'stripe' ? 'From Stripe' : 'From Redis (verify with Stripe)';
        })
        .catch(function () {
          ids.forEach(function (id) { document.getElementById(id).textContent = '--'; });
        });
    }

    function verifyWithStripe() {
      var btn = document.getElementById('stripeVerifyBtn');
      btn.disabled = true;
      btn.textContent = 'Checking...';

      apiFetch('/v1/admin/stats/stripe')
        .then(function (data) {
          document.getElementById('statMRRSub').textContent =
            'Stripe: ' + data.stripeActiveSubscriptions + ' subs, $' + data.stripeMRR + ' MRR';
          showToast('Stripe: ' + data.stripeActiveSubscriptions + ' active subs, $' + data.stripeMRR + ' MRR');
        })
        .catch(function (err) {
          document.getElementById('statMRRSub').textContent = 'Stripe verification failed';
          showToast('Stripe verification failed');
        })
        .finally(function () {
          btn.disabled = false;
          btn.textContent = 'Verify with Stripe';
        });
    }

    // --- Subscribers ---

    function fetchSubscribers() {
      var tbody = document.getElementById('subscribersBody');
      tbody.innerHTML = '<tr class="loading-row"><td colspan="6"><span class="spinner"></span> Loading...</td></tr>';

      apiFetch('/v1/admin/subscribers')
        .then(function (data) {
          subscribersData = data.devices || [];
          renderSubscribers();
        })
        .catch(function () {
          tbody.innerHTML = '<tr><td colspan="6" class="error-state">Failed to load subscribers.</td></tr>';
        });
    }

    function renderSubscribers(filtered) {
      var tbody = document.getElementById('subscribersBody');
      var devices = filtered || subscribersData;

      // Apply filters
      var statusFilter = document.getElementById('subscriberStatusFilter').value;
      var tierFilter = document.getElementById('subscriberTierFilter').value;

      devices = devices.filter(function (d) {
        if (!matchesSearch(d)) return false;
        if (statusFilter === 'active' && d.subscriptionActive !== 'true') return false;
        if (statusFilter === 'inactive' && d.subscriptionActive === 'true') return false;
        if (tierFilter !== 'all' && (d.tier || 'free') !== tierFilter) return false;
        return true;
      });

      document.getElementById('subscribersCount').textContent = devices.length;

      if (devices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No devices match the current filters.</td></tr>';
        return;
      }

      tbody.innerHTML = devices.map(function (d, i) {
        var isActive = d.subscriptionActive === 'true';
        var tierClass = (d.tier || 'free') === 'pro' ? 'badge-pro' : 'badge-free';
        var rowId = 'sub-detail-' + i;
        var customerDisplay = d.email
          ? '<div class="customer-cell"><span class="customer-email">' + esc(d.email) + '</span><span class="customer-device">' + esc(d.deviceId.substring(0, 12)) + '...</span></div>'
          : '<div class="customer-cell"><span class="customer-email" style="color:var(--text-tertiary)">No email</span><span class="customer-device copyable" onclick="event.stopPropagation(); copyText(\'' + escAttr(d.deviceId) + '\')" title="' + escAttr(d.deviceId) + '">' + esc(d.deviceId.substring(0, 16)) + '...</span></div>';

        var mainRow = '<tr class="expandable" onclick="toggleDetail(\'' + rowId + '\', this)">' +
          '<td>' + customerDisplay + '</td>' +
          '<td><span class="badge ' + (isActive ? 'badge-active' : 'badge-inactive') + '">' + (isActive ? 'Active' : 'Inactive') + '</span></td>' +
          '<td><span class="badge ' + tierClass + '">' + esc(d.tier || 'free') + '</span></td>' +
          '<td class="mono">' + esc(d.stripeCustomerId || '--') + '</td>' +
          '<td>' + formatDate(d.registeredAt) + '</td>' +
          '<td>' + formatDate(d.lastSeenAt) + '</td>' +
        '</tr>';

        var detailItems = buildDetailItems(d, ['deviceId', 'email', 'subscriptionActive', 'tier', 'stripeCustomerId', 'subscriptionId', 'registeredAt', 'lastSeenAt']);
        var detailRow = '<tr class="detail-row" id="' + rowId + '"><td colspan="6"><div class="detail-grid">' + detailItems + '</div></td></tr>';
        return mainRow + detailRow;
      }).join('');
    }

    // --- Licenses ---

    function fetchLicenses() {
      var tbody = document.getElementById('licensesBody');
      tbody.innerHTML = '<tr class="loading-row"><td colspan="6"><span class="spinner"></span> Loading...</td></tr>';

      apiFetch('/v1/admin/licenses')
        .then(function (data) {
          licensesData = data.licenses || [];
          renderLicenses();
        })
        .catch(function () {
          tbody.innerHTML = '<tr><td colspan="6" class="error-state">Failed to load licenses.</td></tr>';
        });
    }

    function renderLicenses(filtered) {
      var tbody = document.getElementById('licensesBody');
      var licenses = filtered || licensesData;

      licenses = licenses.filter(function (l) {
        return matchesSearch(l);
      });

      document.getElementById('licensesCount').textContent = licenses.length;

      if (licenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No licenses match the current filters.</td></tr>';
        return;
      }

      tbody.innerHTML = licenses.map(function (l, i) {
        var rowId = 'lic-detail-' + i;
        var mainRow = '<tr class="expandable" onclick="toggleDetail(\'' + rowId + '\', this)">' +
          '<td><span class="mono copyable" onclick="event.stopPropagation(); copyText(\'' + escAttr(l.licenseKey) + '\')" title="Click to copy">' + esc(l.licenseKey) + '</span></td>' +
          '<td><span class="badge badge-pro">' + esc(l.tier) + '</span></td>' +
          '<td>' + formatDate(l.createdAt) + '</td>' +
          '<td>' + esc(l.maxDevices || '1') + '</td>' +
          '<td>' + esc(l.note || '--') + '</td>' +
          '<td>' + (l.activatedDeviceId ? '<span class="mono truncate copyable" onclick="event.stopPropagation(); copyText(\'' + escAttr(l.activatedDeviceId) + '\')" title="' + escAttr(l.activatedDeviceId) + '">' + esc(l.activatedDeviceId.substring(0, 12)) + '...</span>' : '--') + '</td>' +
        '</tr>';

        var detailItems = buildDetailItems(l, ['licenseKey', 'tier', 'createdAt', 'maxDevices', 'note', 'activatedDeviceId', 'activatedAt']);
        var detailRow = '<tr class="detail-row" id="' + rowId + '"><td colspan="6"><div class="detail-grid">' + detailItems + '</div></td></tr>';
        return mainRow + detailRow;
      }).join('');
    }

    function toggleLicenseForm() {
      var form = document.getElementById('licenseForm');
      form.classList.toggle('visible');
    }

    function generateLicense() {
      var tier = document.getElementById('licenseTier').value;
      var note = document.getElementById('licenseNote').value.trim();
      var btn = document.getElementById('createLicenseBtn');
      btn.disabled = true;
      btn.textContent = 'Creating...';

      var body = { tier: tier };
      if (note) body.note = note;

      apiFetch('/v1/admin/generate-license', { method: 'POST', body: body })
        .then(function (data) {
          showToast('License created: ' + data.licenseKey);
          document.getElementById('licenseNote').value = '';
          document.getElementById('licenseForm').classList.remove('visible');
          fetchLicenses();
        })
        .catch(function () {
          showToast('Failed to create license.');
        })
        .finally(function () {
          btn.disabled = false;
          btn.textContent = 'Create';
        });
    }

    // --- Usage (Detailed) ---

    function fetchUsageDetailed() {
      var month = document.getElementById('usageMonth').value;
      if (!month) return;

      var tbody = document.getElementById('usageBody');
      var summary = document.getElementById('usageSummary');
      tbody.innerHTML = '<tr class="loading-row"><td colspan="11"><span class="spinner"></span> Loading...</td></tr>';
      summary.style.display = 'none';

      apiFetch('/v1/admin/usage/detailed?month=' + month)
        .then(function (data) {
          usageData = data.usage || [];
          usageTotals = data.totals || {};
          renderUsage();
          updateCostStats();
        })
        .catch(function () {
          // Fall back to legacy endpoint
          apiFetch('/v1/admin/usage?month=' + month)
            .then(function (data) {
              // Map legacy format to detailed format
              usageData = (data.usage || []).map(function (u) {
                return {
                  deviceId: u.deviceId,
                  email: null,
                  endpoints: {},
                  totalCalls: u.apiCalls,
                  estimatedCost: 0,
                  revenue: 0,
                  profit: 0,
                  isActiveSubscriber: false,
                };
              });
              usageTotals = { totalCalls: data.totalCalls, estimatedCost: 0, revenue: 0, profit: 0, marginPercent: 0 };
              renderUsage();
              updateCostStats();
            })
            .catch(function () {
              tbody.innerHTML = '<tr><td colspan="11" class="error-state">Failed to load usage data.</td></tr>';
              summary.style.display = 'none';
            });
        });
    }

    function renderUsage(filtered) {
      var tbody = document.getElementById('usageBody');
      var summary = document.getElementById('usageSummary');
      var usage = filtered || usageData;

      usage = usage.filter(function (u) {
        return matchesSearch(u);
      });

      if (usage.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No usage data for this month.</td></tr>';
        summary.style.display = 'none';
        return;
      }

      // Summary bar
      var t = usageTotals;
      var hasEnhanced = usage.some(function (u) { return u.costSource === 'enhanced'; });
      var hasLegacy = usage.some(function (u) { return u.costSource === 'blended'; });
      summary.innerHTML =
        '<span>API Cost: <strong class="cost">$' + (t.estimatedCost || 0).toFixed(2) + '</strong></span>' +
        '<span>Revenue: <strong class="revenue">$' + (t.revenue || 0).toFixed(2) + '</strong></span>' +
        '<span>Net: <strong class="profit">$' + (t.profit || 0).toFixed(2) + '</strong> (' + (t.marginPercent || 0) + '%)</span>' +
        '<span>Devices: <strong>' + usage.length + '</strong></span>' +
        (hasEnhanced ? '<span style="color:var(--accent);font-size:11px">&#9679; enhanced = real tokens + estimated whisper/gemini</span>' : '') +
        (hasLegacy ? '<span style="color:var(--text-tertiary);font-size:11px">~est = blended average (no endpoint data)</span>' : '');
      summary.style.display = 'flex';

      tbody.innerHTML = usage.map(function (u) {
        var ep = u.endpoints || {};
        var customerLabel = u.email
          ? esc(u.email)
          : '<span class="mono truncate copyable" onclick="copyText(\'' + escAttr(u.deviceId) + '\')" title="' + escAttr(u.deviceId) + '">' + esc(u.deviceId.substring(0, 14)) + '...</span>';

        var profitClass = u.profit >= 0 ? 'profit-positive' : 'profit-negative';

        // Group by API provider
        var openai = (ep.whisper || 0) + (ep.chat || 0);
        var assemblyai = (ep['assemblyai-submit'] || 0) + (ep['assemblyai-upload'] || 0) + (ep['assemblyai-poll'] || 0);
        var gemini = ep.gemini || 0;

        // Cost display with source indicator
        var displayCost = u.cost !== undefined ? u.cost : (u.estimatedCost || 0);
        var costBadge = '';
        var costTooltip = '';
        if (u.costSource === 'enhanced') {
          costBadge = ' <span style="color:var(--accent);font-size:10px;font-weight:600" title="Real token/duration data from API responses">&#9679;</span>';
          if (u.realCostBreakdown) {
            var rb = u.realCostBreakdown;
            costTooltip = 'Chat: $' + rb.realCostChat.toFixed(4) + ' (' + rb.tokensInputChat + ' in / ' + rb.tokensOutputChat + ' out)' +
              '\\nAAI: $' + rb.realCostAssemblyai.toFixed(4) + ' (' + rb.audioDurationSeconds.toFixed(0) + 's audio)' +
              '\\nWhisper est: $' + rb.whisperEstimate.toFixed(4) +
              '\\nGemini est: $' + rb.geminiEstimate.toFixed(4) +
              (rb.lastModelChat ? '\\nModel: ' + rb.lastModelChat : '');
          }
        } else if (u.costSource === 'blended') {
          costBadge = ' <span style="color:var(--text-tertiary);font-size:10px">~est</span>';
          costTooltip = 'Blended average — no per-endpoint data';
        }

        var costCell = '<td class="right mono"' + (costTooltip ? ' title="' + costTooltip + '" style="cursor:help"' : '') + '>$' + displayCost.toFixed(2) + costBadge + '</td>';

        return '<tr>' +
          '<td>' + customerLabel + '</td>' +
          '<td class="right mono">' + openai + '</td>' +
          '<td class="right mono">' + assemblyai + '</td>' +
          '<td class="right mono">' + gemini + '</td>' +
          '<td class="right"><strong>' + u.totalCalls + '</strong></td>' +
          costCell +
          '<td class="right mono">$' + (u.revenue || 0).toFixed(2) + '</td>' +
          '<td class="right mono ' + profitClass + '">$' + (u.profit || 0).toFixed(2) + '</td>' +
        '</tr>';
      }).join('');
    }

    function updateCostStats() {
      var t = usageTotals;
      if (t && t.estimatedCost !== undefined) {
        document.getElementById('statApiCost').textContent = '$' + (t.estimatedCost || 0).toFixed(2);
        document.getElementById('statApiCostSub').textContent = 'This month';

        var profit = t.profit || 0;
        var margin = t.marginPercent || 0;
        document.getElementById('statNetMargin').textContent = '$' + profit.toFixed(2);
        var marginEl = document.getElementById('statNetMargin');
        marginEl.className = 'stat-card-value ' + (profit >= 0 ? 'green' : 'red');
        document.getElementById('statNetMarginSub').textContent = margin + '% margin';
      }
    }

    // --- Detail Row Helpers ---

    function toggleDetail(rowId, triggerRow) {
      var detail = document.getElementById(rowId);
      if (!detail) return;
      detail.classList.toggle('visible');
      triggerRow.classList.toggle('expanded');
    }

    function buildDetailItems(obj, knownKeys) {
      var allKeys = knownKeys.slice();
      // Include any extra fields from the Redis hash that aren't in the known set
      Object.keys(obj).forEach(function (k) {
        if (allKeys.indexOf(k) === -1) {
          allKeys.push(k);
        }
      });
      return allKeys.map(function (key) {
        var val = obj[key];
        if (val === undefined || val === null) val = '--';
        var displayVal = String(val);
        var isDate = key.toLowerCase().indexOf('at') === key.length - 2 && key.length > 2;
        if (isDate && displayVal !== '--') {
          displayVal = formatDate(displayVal) || displayVal;
        }
        var isCopyable = displayVal.length > 20 || key.toLowerCase().indexOf('id') !== -1 || key.toLowerCase().indexOf('key') !== -1;
        var copyAttr = isCopyable && displayVal !== '--' ? ' class="detail-value copyable" onclick="copyText(\'' + escAttr(displayVal) + '\')" title="Click to copy"' : ' class="detail-value"';
        return '<div class="detail-item"><span class="detail-label">' + esc(formatFieldName(key)) + '</span><span' + copyAttr + '>' + esc(displayVal) + '</span></div>';
      }).join('');
    }

    function formatFieldName(key) {
      // Convert camelCase to Title Case (e.g. "stripeCustomerId" -> "Stripe Customer Id")
      return key.replace(/([A-Z])/g, ' $1').replace(/^./, function (s) { return s.toUpperCase(); });
    }

    // --- Utilities ---

    function formatDate(iso) {
      if (!iso) return '--';
      var d = new Date(iso);
      if (isNaN(d.getTime())) return '--';
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) +
        ' ' + d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    function esc(str) {
      if (!str) return '';
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function escAttr(str) {
      return esc(str).replace(/'/g, "\\'");
    }

    function copyText(text) {
      navigator.clipboard.writeText(text).then(function () {
        showToast('Copied to clipboard');
      });
    }

    var toastTimer;
    function showToast(msg) {
      var el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('visible');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(function () {
        el.classList.remove('visible');
      }, 2500);
    }

    // --- Init ---

    document.getElementById('secretInput').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') handleLogin();
    });

    // Auto-login if secret is still in sessionStorage
    if (getSecret()) {
      showDashboard();
    }

    lucide.createIcons();
  </script>
</body>
</html>
